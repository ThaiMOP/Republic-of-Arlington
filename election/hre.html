<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>เลือกตั้ง ส.ส. - Discord Login</title>
  <link rel="icon" href="https://rep-arlington.pages.dev/assets/img/eca.png" type="image/gif" sizes="16x16">
  <link rel="stylesheet" href="https://slw-system.pages.dev/assets/css/font-face.css">
  <link rel="stylesheet" href="css/main-election.css">
</head>
<body>
  <header>
    <img class="logo" src="https://rep-arlington.pages.dev/assets/img/logo-eca.png" alt="Logo" />
    <div class="profile-container" id="profileContainer">
      <img class="avatar" id="avatar" src="" alt="Avatar" />
      <div class="profile-box" id="profileBox">
        <div id="username" style="margin-bottom: 10px;"></div>
        <button onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="container">
    <h1>การเลือกตั้งสมาชิกสภาผู้แทนราษฎร (ส.ส.)</h1>
    <div class="menu">
      <iframe src="https://rep-arlington.pages.dev/assets/file/บัญชีรายชื่อผู้มีสิทธิลงคะแนนเลือกตั้งสมาชิกสภาผู้แทนราษฎร.pdf" width="100%" height="450px"></iframe>
<!--       <img src="/assets/img/eca/NumberHRE.png"> -->
    </div>
    <center>
<!--       <div id="userInfo"></div> -->
      <div data-election></div>
    </center>
  </div>

  <script src="/assets/js/hre.js"></script>
  <script>
      function logout() {
        localStorage.removeItem('discord_token');
        localStorage.removeItem('election_user_data');
        window.location.href = '/election/login/logout.html';
      }
    
      document.addEventListener("DOMContentLoaded", function () {
    
        // ปิดคลิกขวารูปภาพ
        document.querySelectorAll("img").forEach(img => {
          img.addEventListener("contextmenu", event => event.preventDefault());
        });
    
        // โหลดข้อมูล Discord และสิทธิ์เลือกตั้ง
        const token = localStorage.getItem('discord_token');
        if (token) {
          let discordUserId = null;
    
          fetch('https://discord.com/api/users/@me', {
            headers: { Authorization: `Bearer ${token}` }
          })
            .then(res => res.json())
            .then(user => {
              discordUserId = user.id;
    
              document.getElementById('avatar').src =
                `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
              document.getElementById('username').textContent =
                `${user.username}#${user.discriminator}`;
    
              return fetch('https://script.google.com/macros/s/AKfycbzPzIuqdd2fBRd9z0ZQ8v9UIbxs5t9KP4F8LFHj_RdHbDnvfUVrljP6Ams_yMNXW5lC/exec');
            })
            .then(res => res.json())
            .then(data => {
              const matchedUser = data.find(entry => entry.id === discordUserId);
              const infoBox = document.getElementById("userInfo");
    
              if (matchedUser) {
                localStorage.setItem('election_user_data', JSON.stringify(matchedUser));
    
                const rightText = matchedUser.right === 'มี'
                  ? 'คุณมีสิทธิ์เลือกตั้ง'
                  : 'คุณไม่มีสิทธิ์เลือกตั้งหรือยังไม่ลงทะเบียน';
              } else {
                infoBox.innerHTML = `<p style="color:red;">ไม่พบข้อมูลของคุณในระบบเลือกตั้ง</p>`;
              }
            })
            .catch(err => {
              console.error(err);
              document.body.innerHTML = '<p>เกิดข้อผิดพลาดในการโหลดข้อมูลสิทธิ์เลือกตั้ง</p>';
            });
        } else {
          document.body.innerHTML = '<p>กรุณาเข้าสู่ระบบผ่าน Discord ก่อน</p>';
        }
    
        // จัดการแสดง/ซ่อนโปรไฟล์
        const profileContainer = document.getElementById('profileContainer');
        const profileBox = document.getElementById('profileBox');
    
        profileContainer?.addEventListener('click', () => {
          profileBox.classList.toggle('show');
        });
    
        window.addEventListener('click', (e) => {
          if (!profileContainer?.contains(e.target)) {
            profileBox.classList.remove('show');
          }
        });
      });
  </script>

</body>
</html>
