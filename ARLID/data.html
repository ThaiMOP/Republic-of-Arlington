<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</title>
  <link rel="icon" href="https://rep-arlington.pages.dev/assets/img/logo.png" type="image/gif" sizes="16x16">
  <link rel="stylesheet" href="https://slw-system.pages.dev/assets/css/font-face.css">
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: CPN;
      font-size: 1.5rem;
    }
    #log {
      background: #f1f1f1;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div id="log">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î...</div>

  <script>
    const logEl = document.getElementById("log");
    function log(text) {
      console.log(text);
      logEl.textContent += `\n${text}`;
    }

    const apiUrl = "https://script.google.com/macros/s/AKfycbz3MGxCG1OSpLa6Wh1n4i1SDLAHCvoAU9DB5RICnyasEeUEpTk-lNadVz-YL_AaMSDTtw/exec";
    const discordToken = localStorage.getItem('discord_token');
    const userDataEncoded = localStorage.getItem('election_user_data');
    let userData = null;

    function redirectToDashboard() {
      log("‚û° ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà /ARLID/dashboard");
      setTimeout(() => {
        window.location.href = "/ARLID/dashboard";
      }, 1000);
    }

    async function main() {
      log("üì¶ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LocalStorage...");
      if (!userDataEncoded) {
        log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö election_user_data");
        return redirectToDashboard();
      }

      try {
        userData = JSON.parse(userDataEncoded); // ‚úÖ ‡πÉ‡∏ä‡πâ JSON ‡∏õ‡∏Å‡∏ï‡∏¥
        log("‚úÖ ‡πÇ‡∏´‡∏•‡∏î userData ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ID = " + userData.id);
      } catch (err) {
        log("‚ùå ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• userData ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        return redirectToDashboard();
      }

      if (!userData || !userData.id) {
        log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö userData.id");
        return redirectToDashboard();
      }

      log("üåê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API...");
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        log("‚úÖ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API ‡πÅ‡∏•‡πâ‡∏ß");

        const match = data.find(item => item.id === userData.id);
        if (!match) {
          log("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö ID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô API");
          return redirectToDashboard();
        }

        log("‚úÖ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• link: " + match.link);
        if (match.link === "Unable to access this website") {
          alert("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ");
          return redirectToDashboard();
        } else {
          const targetUrl = "data-eca" + match.link;
          log("‚û° ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà: " + targetUrl);
          setTimeout(() => {
            window.location.href = targetUrl;
          }, 1000);
        }
      } catch (err) {
        log("‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
        return redirectToDashboard();
      }
    }

    main();
  </script>
</body>
</html>
