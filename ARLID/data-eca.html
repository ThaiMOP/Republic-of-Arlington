<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡∏£‡∏Ñ</title>
  <link rel="icon" href="/assets/img/logo.png" type="image/gif" sizes="16x16">
  <link rel="stylesheet" href="https://slw-system.pages.dev/assets/css/font-face.css">
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: CPN, sans-serif;
    }
    *, ::after, ::before {
        box-sizing: border-box;
    }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; }
    input, select { width: 100%; }
    button { margin: 5px; }
  </style>
</head>
<body>
  <h2 id="party-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡∏£‡∏Ñ</h2>
  <table id="data-table">
    <thead>
      <tr>
        <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
        <th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</th>
        <th>‡∏•‡∏ö</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="addRow()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
  <button onclick="saveData()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>

  <script>
    const partyMap = {
      dem: "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡πÑ‡∏ï‡∏¢",
      pfp: "‡πÄ‡∏™‡∏£‡∏µ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô",
      nfp: "‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏´‡∏°‡πà",
      eca: "‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á"
    };
    
    const query = new URLSearchParams(window.location.search);
    const key = [...partyMap.keys()].find(k => query.has(k));
    const currentParty = partyMap[key];
    
    document.getElementById("party-title").textContent = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡∏£‡∏Ñ: " + (currentParty || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏£‡∏£‡∏Ñ");
    
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwUY78FvPyV6QHElIjTDpZIfgMe0FKRZdobDFomjkEQrdha5T6GVQQBy3Xi_Odrb6AG/exec';
    
    async function fetchData() {
      if (!currentParty) return;
    
      // üîΩ ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏û‡∏£‡πâ‡∏≠‡∏° action=read ‡πÅ‡∏•‡∏∞ party=...
      const url = `${scriptURL}?action=read&party=${encodeURIComponent(currentParty)}`;
    
      const res = await fetch(url);
      const data = await res.json();
      const tbody = document.querySelector("#data-table tbody");
      tbody.innerHTML = '';
    
      data.forEach((item, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td><input type="text" value="${item.name}" /></td>
          <td><input type="text" value="${item.id}" readonly /></td>
          <td><button onclick="removeRow(this)">‡∏•‡∏ö</button></td>
        `;
        tbody.appendChild(tr);
      });
    }


    function addRow() {
      const tbody = document.querySelector("#data-table tbody");
      const rowCount = tbody.rows.length + 1;
      const newRow = document.createElement("tr");
      const uniqueId = 'id-' + Date.now();
      newRow.innerHTML = `
        <td>${rowCount}</td>
        <td><input type="text" /></td>
        <td><input type="text" value="${uniqueId}" readonly /></td>
        <td><button onclick="removeRow(this)">‡∏•‡∏ö</button></td>
      `;
      tbody.appendChild(newRow);
    }

    function removeRow(button) {
      const row = button.closest("tr");
      row.remove();
    }

    async function saveData() {
      const rows = document.querySelectorAll("#data-table tbody tr");
      const data = Array.from(rows).map(row => {
        const name = row.cells[1].querySelector("input").value;
        const id = row.cells[2].querySelector("input").value;
        return { name, id, party: currentParty };
      });

      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({ action: "write", data })
      });

      if (res.ok) {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        fetchData();
      } else {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }

    fetchData();
  </script>
</body>
</html>
